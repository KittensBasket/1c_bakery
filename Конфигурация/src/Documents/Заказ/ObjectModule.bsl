Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)

    Подтвержден = Ложь;

    СуммаЗаказа = 0;
    Для Каждого СтрокаТЧ Из Продукция Цикл
        СуммаЗаказа = СуммаЗаказа + СтрокаТЧ.Сумма;
    КонецЦикла;

    МинимальнаяСумма = 500;

    Если СуммаЗаказа > МинимальнаяСумма Тогда
        Подтвержден = Истина;
    Иначе
        Подтвержден = Ложь;
    КонецЕсли;

    ЭтотОбъект.Подтвержден = Подтвержден;

КонецПроцедуры



Процедура ОбработкаПроведения(Отказ, РежимПроведения)

    // Проверяем, подтвержден ли заказ
    Если Не ЭтотОбъект.Подтвержден Тогда
        Возврат;
    КонецЕсли;

    // Создаем документ ОтгрузкаКлиенту
    Попытка

        НоваяОтгрузка = Документы.ОтгрузкаКлиенту.СоздатьДокумент();

        // Заполняем реквизиты шапки
        НоваяОтгрузка.Клиент = ЭтотОбъект.Клиент;
        НоваяОтгрузка.Дата = ТекущаяДата();
        НоваяОтгрузка.ЗаказОснование = Ссылка;

        // Копируем табличную часть
        Для Каждого СтрокаЗаказа Из Продукция Цикл
            НоваяСтрока = НоваяОтгрузка.Продукция.Добавить();
            НоваяСтрока.Продукция  = СтрокаЗаказа.Продукция;
            НоваяСтрока.Количество = СтрокаЗаказа.Количество;
            НоваяСтрока.Цена       = СтрокаЗаказа.Цена;
            НоваяСтрока.Сумма      = СтрокаЗаказа.Сумма;
        КонецЦикла;

        // Сначала записываем, затем проводим
        НоваяОтгрузка.Записать();

        Попытка
            НоваяОтгрузка.Провести(); // создаст движения по ОстаткиПродукции
        Исключение
            Сообщить("Внимание! Автоматическая отгрузка не была проведена: " + ОписаниеОшибки(), СтатусСообщения.Важное);
            // Если нужно отменять проведение заказа при неуспешной отгрузке, раскомментируйте:
            // Отказ = Истина;
        КонецПопытки;

    Исключение
        Сообщить("Внимание! Автоматическая отгрузка не была создана: " + ОписаниеОшибки(), СтатусСообщения.Важное);
        // Если нужно отменять проведение заказа при ошибке создания, раскомментируйте:
        // Отказ = Истина;
    КонецПопытки;

КонецПроцедуры
