&НаКлиенте
Процедура ЗаполнитьТочки(Команда)
    // Получаем данные текущей выделенной строки в таблице маршрутов
    ТекущиеДанныеМаршрута = Элементы.СписокМаршрутов.ТекущиеДанные;
    
    Если ТекущиеДанныеМаршрута <> Неопределено Тогда
        ЗаполнитьКлиентовПоМаршрутамНаСервере(ТекущиеДанныеМаршрута.Маршрут);
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьКакВчера(Команда)
	ТекущиеДанные = Элементы.СписокКлиентов.ТекущиеДанные;
	ПеременнаяТекущийКлиент = ТекущиеДанные.Клиент; 
	ЗаполнитьСоставЗаказаКакВчераНаСервере(ПеременнаяТекущийКлиент);
КонецПроцедуры

// Событие таблицы СписокКлиентов (ПриАктивизацииСтроки)
&НаКлиенте
Процедура СписокКлиентовПриАктивизацииСтроки(Элемент)
    
    // Получаем ссылку на клиента из активизированной строки
    ТекущиеДанные = Элементы.СписокКлиентов.ТекущиеДанные;
    
    Если ТекущиеДанные <> Неопределено Тогда
        
        ПеременнаяТекущийКлиент = ТекущиеДанные.Клиент; 
        
        // Вызываем функцию заполнения состава заказа по шаблонам
        ЗаполнитьСоставЗаказаПоШаблонуНаСервере(ПеременнаяТекущийКлиент); 
    Иначе
        // Если строка снята с выделения, очищаем переменные и таблицу
        ПеременнаяТекущийКлиент = Неопределено;
        СоставЗаказа.Очистить();
    КонецЕсли;
КонецПроцедуры


// Точки заполняются для выбранного маршрута
// Процедура для кнопки "Заполнить точки"
&НаСервере
Процедура ЗаполнитьКлиентовПоМаршрутамНаСервере(ВыбранныйМаршрут)
        
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    | МаршрутыСписокТочек.Клиент КАК Клиент,
    | ЛОЖЬ КАК Заказать
    |ИЗ
    | Справочник.Маршруты.СписокКлиентов КАК МаршрутыСписокТочек
    |ГДЕ
    | МаршрутыСписокТочек.Ссылка = &ВыбранныйМаршрут
    |УПОРЯДОЧИТЬ ПО
    | МаршрутыСписокТочек.НомерСтроки";
    
    Запрос.УстановитьПараметр("ВыбранныйМаршрут", ВыбранныйМаршрут);
    
    СписокКлиентов.Очистить();
    СписокКлиентов.Загрузить(Запрос.Выполнить().Выгрузить());
    
КонецПроцедуры

// Процедура для заполнения правой части данными из шаблона заказов
&НаСервере
Процедура ЗаполнитьСоставЗаказаПоШаблонуНаСервере(КлиентСсылка)
    
    СоставЗаказа.Очистить();
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ШаблоныЗаказов.Продукция,
    |    ШаблоныЗаказов.Количество
    |ИЗ
    |    РегистрСведений.ШаблонЗаказов КАК ШаблоныЗаказов
    |ГДЕ
    |    ШаблоныЗаказов.Клиент = &Клиент";
    
    Запрос.УстановитьПараметр("Клиент", КлиентСсылка);
    
    ВыборкаШаблона = Запрос.Выполнить().Выбрать();
    
    Пока ВыборкаШаблона.Следующий() Цикл
        
        // Получаем текущую цену из регистра "ЦеныПродукции"
        Отбор = Новый Структура;
        Отбор.Вставить("Клиент", КлиентСсылка);
        Отбор.Вставить("Продукция", ВыборкаШаблона.Продукция);
        
        // Получаем цену на текущую дату
        ЗначенияРесурсов = РегистрыСведений.ЦеныПродукции.ПолучитьПоследнее(ТекущаяДата(), Отбор);
        
        ЦенаПродукции = 0;
        Если ЗначенияРесурсов.Свойство("Цена") Тогда
            ЦенаПродукции = ЗначенияРесурсов.Цена;
        КонецЕсли;
        
        // Вычисляем сумму
        Количество = ВыборкаШаблона.Количество;
        Сумма = Количество * ЦенаПродукции;
        
        НоваяСтрока = СоставЗаказа.Добавить();
        
        НоваяСтрока.Номенклатура = ВыборкаШаблона.Продукция; 
        НоваяСтрока.Количество = Количество;
        НоваяСтрока.Цена = ЦенаПродукции;
        НоваяСтрока.Сумма = Сумма;
        
    КонецЦикла;

КонецПроцедуры

// Событие таблицы СписокКлиентов (ПриИзменении)
&НаКлиенте
Процедура СписокКлиентовПриИзменении(Элемент)
    
    ТекущиеДанные = Элементы.СписокКлиентов.ТекущиеДанные;
    
    // Проверяем, что есть текущие данные
    Если ТекущиеДанные <> Неопределено Тогда
        
        Если ТекущиеДанные.Заказать Тогда
            // Флажок установлен - вызываем создание заказа
            СоздатьЗаказКлиентаНаСервере(ТекущиеДанные.Клиент);

        КонецЕсли;
        
    КонецЕсли;
КонецПроцедуры

// Создание документа "ЗаказКлиента" для выбранного клиента
&НаСервере
Процедура СоздатьЗаказКлиентаНаСервере(КлиентСсылка)
    
    // Проверяем, что в составе заказа есть строки для создания документа
    Если СоставЗаказа.Количество() = 0 Тогда
        Сообщить("Нет шаблонов заказа. Заказ не создан");
        Возврат;
    КонецЕсли;
    
    НовыйЗаказ = Документы.Заказ.СоздатьДокумент();
    
    НовыйЗаказ.Клиент = КлиентСсылка; // Указываем клиента
    НовыйЗаказ.Дата = ТекущаяДата(); // Дата заказа - текущая дата
    // Дата отгрузки по умолчанию - завтрашняя дата 
    НовыйЗаказ.ДатаОтгрузки = НачалоДня(ТекущаяДата()) + 60*60*24; 
    
    // Переносим строки из таблицы формы "СоставЗаказа" в табличную часть документа
    Для Каждого СтрокаСостава Из СоставЗаказа Цикл
        
        НоваяСтрокаТЧ = НовыйЗаказ.Продукция.Добавить();
        НоваяСтрокаТЧ.Продукция = СтрокаСостава.Номенклатура;
        НоваяСтрокаТЧ.Количество = СтрокаСостава.Количество;
        // Цена и Сумма заполняются из данных на форме.
        // Обратите внимание: в документе "ЗаказКлиента" цена определяется 
        // из назначенной клиенту цены на продукцию, на дату отгрузки[cite: 63].
        // Но на форме "Рабочее место менеджера" она уже была получена.
        // В данном случае, просто копируем ее.
        НоваяСтрокаТЧ.Цена = СтрокаСостава.Цена;
        НоваяСтрокаТЧ.Сумма = СтрокаСостава.Сумма; 
        
    КонецЦикла;
    
    НовыйЗаказ.Записать(РежимЗаписиДокумента.Проведение);
    // Сообщаем об успешном создании заказа
    Сообщить("Для клиента " + КлиентСсылка + " создан Заказ клиента №" + НовыйЗаказ.Номер + " от " + НовыйЗаказ.Дата);
    
КонецПроцедуры

// Заполнение состава заказа для выбранного клиента по вчерашнему заказу
&НаСервере
Процедура ЗаполнитьСоставЗаказаКакВчераНаСервере(КлиентСсылка)
    
    СоставЗаказа.Очистить();
    
    ДатаОтгрузкиВчера = НачалоДня(ТекущаяДата()) - 60*60*24;
    
    ЗапросНайтиЗаказ = Новый Запрос;
    ЗапросНайтиЗаказ.Текст =
    "ВЫБРАТЬ ПЕРВЫЕ 1
    | ЗаказКлиента.Ссылка
    |ИЗ
    | Документ.Заказ КАК ЗаказКлиента
    |ГДЕ
    | ЗаказКлиента.Клиент = &Клиент
    | И ЗаказКлиента.ДатаОтгрузки = &ДатаОтгрузкиВчера
    |УПОРЯДОЧИТЬ ПО
    | ЗаказКлиента.Дата УБЫВ";
    
    ЗапросНайтиЗаказ.УстановитьПараметр("Клиент", КлиентСсылка);
    ЗапросНайтиЗаказ.УстановитьПараметр("ДатаОтгрузкиВчера", ДатаОтгрузкиВчера);
    
    РезультатНайтиЗаказ = ЗапросНайтиЗаказ.Выполнить();
    ВыборкаНайтиЗаказ = РезультатНайтиЗаказ.Выбрать();
    
    Если Не ВыборкаНайтиЗаказ.Следующий() Тогда
        Сообщить("Заказ, исполненный вчера (" + Формат(ДатаОтгрузкиВчера, "ДФ=dd.MM.yyyy") + "), для клиента " + КлиентСсылка + " не найден.");
        Возврат;
    КонецЕсли;
    
    СсылкаНаЗаказВчера = ВыборкаНайтиЗаказ.Ссылка;
    
    ЗапросСостава = Новый Запрос;
    ЗапросСостава.Текст =
    "ВЫБРАТЬ
    | ЗаказКлиентаПродукция.Продукция КАК Продукция,
    | ЗаказКлиентаПродукция.Количество КАК Количество
    |ИЗ
    | Документ.Заказ.Продукция КАК ЗаказКлиентаПродукция
    |ГДЕ
    | ЗаказКлиентаПродукция.Ссылка = &СсылкаНаЗаказВчера";
    
    ЗапросСостава.УстановитьПараметр("СсылкаНаЗаказВчера", СсылкаНаЗаказВчера);
    
    ВыборкаПродукции = ЗапросСостава.Выполнить().Выбрать();
    
    ДатаОтгрузкиЗавтра = НачалоДня(ТекущаяДата()) + 60*60*24;
    
    Пока ВыборкаПродукции.Следующий() Цикл
        
        Отбор = Новый Структура;
        Отбор.Вставить("Клиент", КлиентСсылка);
        Отбор.Вставить("Продукция", ВыборкаПродукции.Продукция);
        
        ЗначенияРесурсов = РегистрыСведений.ЦеныПродукции.ПолучитьПоследнее(ДатаОтгрузкиЗавтра, Отбор);
        
        ЦенаПродукции = 0;
        Если ЗначенияРесурсов.Свойство("Цена") Тогда
            ЦенаПродукции = ЗначенияРесурсов.Цена;
        КонецЕсли;
        
        Количество = ВыборкаПродукции.Количество;
        Сумма = Количество * ЦенаПродукции;
        
        НоваяСтрока = СоставЗаказа.Добавить();
        
        НоваяСтрока.Номенклатура = ВыборкаПродукции.Продукция; 
        НоваяСтрока.Количество = Количество;
        НоваяСтрока.Цена = ЦенаПродукции;
        НоваяСтрока.Сумма = Сумма;
        
    КонецЦикла;

КонецПроцедуры